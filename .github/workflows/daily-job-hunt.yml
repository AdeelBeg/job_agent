name: Daily Job Hunt

on:
  schedule:
    - cron: '0 8 * * 1-5'
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install Python Dependencies
        run: |
          uv pip install --system -r requirements.txt
          uv pip install --system playwright

      - name: Install Playwright Browser
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2t64 \
            libx11-xcb1
          playwright install chromium


      - name: Restore Database from Cache
        uses: actions/cache@v4
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}
          restore-keys: jobs-db-

      - name: Create Data Directory
        run: mkdir -p data logs/screenshots

      - name: Write Resume from Secret
        run: echo "$RESUME_TEXT" > data/resume.txt
        env:
          RESUME_TEXT: ${{ secrets.RESUME_TEXT }}

      - name: Write User Info from Secret
        run: echo "$USER_INFO_JSON" > data/user_info.json
        env:
          USER_INFO_JSON: ${{ secrets.USER_INFO_JSON }}

      - name: Run Job Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
          ADZUNA_COUNTRY: ${{ secrets.ADZUNA_COUNTRY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MATCH_THRESHOLD: ${{ vars.MATCH_THRESHOLD || '0.42' }}
          MAX_JOBS_PER_RUN: ${{ vars.MAX_JOBS_PER_RUN || '15' }}
          AUTO_APPLY: ${{ vars.AUTO_APPLY || 'false' }}
          JOB_KEYWORDS: ${{ vars.JOB_KEYWORDS || 'ai engineer,ml engineer,llm engineer' }}
        run: python main.py

      - name: Save Database
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}

      - name: Upload Screenshots as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-screenshots-${{ github.run_number }}
          path: logs/screenshots/
          retention-days: 30