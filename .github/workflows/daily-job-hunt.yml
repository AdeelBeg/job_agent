name: Daily Job Hunt

on:
  schedule:
    - cron: '0 8 * * 1-5'   # 8:00 AM UTC, Mon-Fri
  workflow_dispatch:          # Manual trigger

jobs:
  run-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Use official Playwright Docker image â€” zero browser dependency issues
    container:
      image: mcr.microsoft.com/playwright/python:v1.44.0-jammy

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Python Dependencies
        run: pip install --no-cache-dir -r requirements.txt

      - name: Restore Database from Cache
        uses: actions/cache@v4
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}
          restore-keys: jobs-db-

      - name: Create Data Directory
        run: mkdir -p data logs/screenshots

      - name: Write Resume from Secret
        run: echo "$RESUME_TEXT" > data/resume.txt
        env:
          RESUME_TEXT: ${{ secrets.RESUME_TEXT }}

      - name: Write User Info from Secret
        run: echo "$USER_INFO_JSON" > data/user_info.json
        env:
          USER_INFO_JSON: ${{ secrets.USER_INFO_JSON }}

      - name: Run Job Agent
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }} 
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
          ADZUNA_COUNTRY: ${{ secrets.ADZUNA_COUNTRY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MATCH_THRESHOLD: ${{ vars.MATCH_THRESHOLD || '0.42' }}
          MAX_JOBS_PER_RUN: ${{ vars.MAX_JOBS_PER_RUN || '15' }}
          AUTO_APPLY: ${{ vars.AUTO_APPLY || 'false' }}
          JOB_KEYWORDS: ${{ vars.JOB_KEYWORDS || 'ai engineer,ml engineer,llm engineer' }}
        run: python main.py

      - name: Save Database
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}

      - name: Upload Screenshots as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-screenshots-${{ github.run_number }}
          path: logs/screenshots/
          retention-days: 30
      - name: Upload Database as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jobs-db-${{ github.run_number }}
          path: data/jobs.db
          retention-days: 7