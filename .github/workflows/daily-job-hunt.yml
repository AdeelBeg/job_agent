name: Daily Job Hunt

on:
  schedule:
    - cron: '0 8 * * 1-5'   # 8:00 AM UTC, Mon-Fri
  workflow_dispatch:        # Allows manual trigger

jobs:
  run-agent:
    # FIX: Use 22.04 to avoid the libasound2t64 error found in 24.04
    runs-on: ubuntu-22.04 
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      # 2. Set up Python
      - name: Set up Python 3.12
        run: uv python install 3.12

      # 3. Install Requirements & Playwright
      - name: Install Dependencies
        run: |
          # This installs your libraries (Groq, etc.)
          uv pip install --system -r requirements.txt
          
          # This installs Playwright and the necessary system browser deps
          uv pip install --system playwright
          uv run playwright install chromium --with-deps

      # 4. Persistence (Database)
      - name: Restore Database from Cache
        uses: actions/cache@v4
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}
          restore-keys: jobs-db-

      - name: Create Data Directory
        run: mkdir -p data logs/screenshots

      # 5. Build Secrets
      - name: Write Resume from Secret
        run: echo "$RESUME_TEXT" > data/resume.txt
        env:
          RESUME_TEXT: ${{ secrets.RESUME_TEXT }}

      - name: Write User Info from Secret
        run: echo "$USER_INFO_JSON" > data/user_info.json
        env:
          USER_INFO_JSON: ${{ secrets.USER_INFO_JSON }}

      # 6. Run the Agent
      - name: Run Job Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
          ADZUNA_COUNTRY: ${{ secrets.ADZUNA_COUNTRY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MATCH_THRESHOLD: ${{ vars.MATCH_THRESHOLD || '0.42' }}
          MAX_JOBS_PER_RUN: ${{ vars.MAX_JOBS_PER_RUN || '15' }}
          AUTO_APPLY: ${{ vars.AUTO_APPLY || 'false' }}
          JOB_KEYWORDS: ${{ vars.JOB_KEYWORDS || 'ai engineer,ml engineer,llm engineer' }}
        run: uv run main.py

      # 7. Save Database for next run
      - name: Save Database
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}

      # 8. Upload Artifacts
      - name: Upload Screenshots as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-screenshots-${{ github.run_number }}
          path: logs/screenshots/
          retention-days: 30