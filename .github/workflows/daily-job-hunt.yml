name: Daily Job Hunt

on:
  schedule:
    - cron: '0 8 * * 1-5'   # 8:00 AM UTC, Mon-Fri only
  workflow_dispatch:          # Allows manual trigger from GitHub UI

jobs:
  run-agent:
    # Using 22.04 specifically to avoid the libasound2t64 naming conflict in 24.04
    runs-on: ubuntu-22.04 
    timeout-minutes: 30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install uv (astral-sh official action)
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      # 2. Set up Python 3.12 using uv
      - name: Set up Python 3.12
        run: uv python install 3.12

      # 3. Install Dependencies & Playwright Browsers
      - name: Install Dependencies
        run: |

          uv pip install --system -r requirements.txt

          # 1. Update and install the new version of the library
          sudo apt-get update
          sudo apt-get install -y libasound2t64
          # 2. Create a "symlink" (a shortcut) so Playwright finds what it expects
          # This tricks the installer into thinking libasound2 is present
          sudo ln -s /usr/lib/x86_64-linux-gnu/libasound.so.2 /usr/lib/x86_64-linux-gnu/libasound2

          # 3. Upgrade Playwright to the absolute latest version
          uv pip install --system --upgrade playwright

          # 4. Install browsers and dependencies
          # --with-deps ensures OS-level libraries for Chromium are installed
          uv run playwright install chromium --with-deps

      # 4. Persistence: Restore Database from Cache
      - name: Restore Database from Cache
        uses: actions/cache@v4
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}
          restore-keys: jobs-db-

      # 5. Prepare Workspace
      - name: Create Data Directory
        run: mkdir -p data logs/screenshots

      # 6. Build Files from GitHub Secrets
      - name: Write Resume from Secret
        run: echo "$RESUME_TEXT" > data/resume.txt
        env:
          RESUME_TEXT: ${{ secrets.RESUME_TEXT }}

      - name: Write User Info from Secret
        run: echo "$USER_INFO_JSON" > data/user_info.json
        env:
          USER_INFO_JSON: ${{ secrets.USER_INFO_JSON }}

      # 7. Execute the Agent
      - name: Run Job Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_APP_KEY: ${{ secrets.ADZUNA_APP_KEY }}
          ADZUNA_COUNTRY: ${{ secrets.ADZUNA_COUNTRY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # These can be set in Settings > Variables > Actions
          MATCH_THRESHOLD: ${{ vars.MATCH_THRESHOLD || '0.42' }}
          MAX_JOBS_PER_RUN: ${{ vars.MAX_JOBS_PER_RUN || '15' }}
          AUTO_APPLY: ${{ vars.AUTO_APPLY || 'false' }}
          JOB_KEYWORDS: ${{ vars.JOB_KEYWORDS || 'ai engineer,ml engineer,llm engineer' }}
        run: uv run main.py

      # 8. Save Database state for next run
      - name: Save Database
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/jobs.db
          key: jobs-db-${{ github.run_number }}

      # 9. Store artifacts (helpful for debugging failures)
      - name: Upload Screenshots as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-screenshots-${{ github.run_number }}
          path: logs/screenshots/
          retention-days: 30